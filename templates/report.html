<!DOCTYPE html>
<html>
<head>
    <title>Microbial Source Tracker</title>
    <meta name="google" value="notranslate">
    <script src="https://code.jquery.com/jquery-3.1.1.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"></script>
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/examples.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/vizuly.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/vizuly_halo.css') }}">
    <script src="{{ url_for('static', filename='js/jquery.form.js') }}" type="text/javascript"></script>
    <script src="{{ url_for('static', filename='js/index.js') }}" type="text/javascript"></script>
    <script src="{{ url_for('static', filename='js/d3.min.js') }}" typ e="text/javascript"></script>
    <script src="{{ url_for('static', filename='js/vizuly_core.min.js') }}" type="text/javascript"></script>
    <script src="{{ url_for('static', filename='js/vizuly_halo.min.js') }}" type="text/javascript"></script>
    <script src="{{ url_for('static', filename='js/halo_test_AR.js') }}" type="text/javascript"></script>
    <script src="{{ url_for('static', filename='js/braycurtis_heatmap.js') }}" type="text/javascript"></script>
    <style>
        body {
          -webkit-print-color-adjust: exact !important;
        }
        .chart-item {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 1px solid rgba(0,0,0,0.1);
            border-radius: 10px;
            box-shadow: 2px 2px rgba(0,0,0,0.1);
        }

        .chart-item:hover {
            border: 1px solid rgba(255,255,255,0.8);
        }

        .legend td {
            padding: 2px 10px;
        }

        .borderless td, .borderless th {
            border-top: none !important;
        }

    </style>
</head>
<body>
   <body>
        <div class="container">
            <div class="row">
                <div class="col-md-12" style="padding: 30px;">
                    <h2>FORENSIC Classifier Report</h2>
                </div>
            </div>
            {% if data.exists %}
                {% if data.successful %}
                <div class="row">
                    <div class="col-md-4">
                        <div class="panel panel-default">
                          <div class="panel-heading">Task details</div>
                          <div class="panel-body">
                            <table class="table borderless">
                                <tr>
                                    <td>Sender:</td>
                                    <td>{{ data.email }}</td>
                                </tr>
                                <tr>
                                    <td>Submitted:</td>
                                    <td>5 Days ago</td>
                                </tr>
                                <tr>
                                    <td>Total sample:</td>
                                    <td>{{ data.Clostridiales|length - 1 }}</td>
                                </tr>
                                <tr>
                                    <td>16S rDNA region detected:</td>
                                    <td>{{ data.region }}</td>
                                </tr>
                            </table>
                            <div style="text-align: center">
                              <button type="button" class="btn btn-primary" onclick="location.href=location.href + '/download';">
                                <span class="glyphicon glyphicon-download"></span> Download report
                              </button>
                              <button type="button" class="btn btn-success" onclick="window.print();">
                                <span class="glyphicon glyphicon-print"></span> Print
                              </button>
                            </div>
                          </div>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <div class="alert alert-info" role="alert">
                            <p>The fasta submitted has been processed through both <i><b>Clostridiales</b></i> and <i><b>Bacteroidales</b></i> classifiers. Tables summarize the fecal source identification predictions generated using random forest.</p>
                            
                            <p>A Bray-Curtis dissimilarity matrices depict the difference of bacterial assemblages composition between the <i><b>Clostridiales</b></i> and <i><b>Bacteroidales</b></i> classifiers and the samples. The relative abundance of the selected ASVs, as well as their repartition between the different sources investigated is presented in a bubble plot per sample.</p></div>
                        <div class="panel panel-default">
                          <div class="panel-heading">Clostridiales</div>
                          <div class="panel-body">
                              <table class="table">
                                {% for row in data.Clostridiales %}
                                    {% set outer_loop = loop %}
                                    {% if outer_loop.index == 1 %}
                                    <thead>
                                    {% endif %}
                                    <tr>
                                    {% for item in row %}
                                        {% if outer_loop.index == 1 %}
                                        <th>
                                        {% else %}
                                        <td style="text-align: center">
                                        {% endif %}
                                            {% if outer_loop.index == 1 and loop.index == 1 %}
                                                Sample Name
                                                </th>
                                                <th style="text-align: center">
                                                {{item}}
                                            {% elif outer_loop.index == 1 or loop.index == 1 %}
                                                {{ item }}
                                            {% else %}
                                                <div class="chart-item" style="background-color: 
                                                {% if item|float() < 40|float() %}
                                                    #ffffff
                                                {% elif item|float() < 45|float() %}
                                                    #FEE08B
                                                {% elif item|float() < 50|float() %}
                                                    #D53E4F
                                                {% else %}
                                                    #9E0142
                                                {% endif %}
                                                !important;"  data-toggle="tooltip" data-placement="top" title="{{ item }}">
                                                </div>
                                            {% endif %}
                                       {% if outer_loop.index == 1 %}
                                        <th>
                                        {% else %}
                                        <td>
                                        {% endif %}
                                    {% endfor %}
                                    </tr>
                                    {% if outer_loop.index == 1 %}
                                    </thead>
                                    {% endif %}
                                {% endfor %}
                                </table>
                                <div style="float: right;">
                                    <table class="legend">
                                        <tr>
                                            <td rowspan="2">Legend</td>
                                            <td>&lt;40</td>
                                            <td>&lt;45</td>
                                            <td>&lt;50</td>
                                            <td>&#8805;50</td>
                                            <td>%</td>
                                        </tr>
                                        <tr>
                                            <td><div class="chart-item" style="background-color: #ffffff !important;"></div></td>
                                            <td><div class="chart-item" style="background-color: #FEE08B !important;"></div></td>
                                            <td><div class="chart-item" style="background-color: #D53E4F !important;"></div></td>
                                            <td><div class="chart-item" style="background-color: #9E0142 !important;"></div></td>
                                            <td></td>
                                        </tr>
                                    </table>
                                </div>
                          </div>
                        </div>
                        <div class="panel panel-default">
                          <div class="panel-heading">Bacteroidales</div>
                          <div class="panel-body">
                              <table class="table">
                                {% for row in data.Bacteroidales %}
                                    {% set outer_loop = loop %}
                                    {% if outer_loop.index == 1 %}
                                    <thead>
                                    {% endif %}
                                    <tr>
                                    {% for item in row %}
                                        {% if outer_loop.index == 1 %}
                                        <th>
                                        {% else %}
                                        <td style="text-align: center">
                                        {% endif %}
                                            {% if outer_loop.index == 1 and loop.index == 1 %}
                                                Sample Name
                                                </th>
                                                <th style="text-align: center">
                                                {{ item }}
                                            {% elif outer_loop.index == 1 or loop.index == 1 %}
                                                {{ item }}
                                            {% else %}
                                                <div class="chart-item" style="background-color: 
                                                {% if item|float() < 40|float() %}
                                                    #ffffff
                                                {% elif item|float() < 45|float() %}
                                                    #FEE08B
                                                {% elif item|float() < 50|float() %}
                                                    #D53E4F
                                                {% else %}
                                                    #9E0142
                                                {% endif %}
                                                !important;" data-toggle="tooltip" data-placement="top" title="{{ item }}">

                                                </div>
                                            {% endif %}
                                       {% if outer_loop.index == 1 %}
                                        <th>
                                        {% else %}
                                        <td>
                                        {% endif %}
                                    {% endfor %}
                                    </tr>
                                    {% if outer_loop.index == 1 %}
                                    </thead>
                                    {% endif %}
                                {% endfor %}
                                </table>
                                <div style="float: right;">
                                    <table class="legend">
                                        <tr>
                                            <td rowspan="2">Legend</td>
                                            <td>&lt;40</td>
                                            <td>&lt;45</td>
                                            <td>&lt;50</td>
                                            <td>&#8805;50</td>
                                            <td>%</td>
                                        </tr>
                                        <tr>
                                            <td><div class="chart-item" style="background-color: #ffffff !important;"></div></td>
                                            <td><div class="chart-item" style="background-color: #FEE08B !important;"></div></td>
                                            <td><div class="chart-item" style="background-color: #D53E4F !important;"></div></td>
                                            <td><div class="chart-item" style="background-color: #9E0142 !important;"></div></td>
                                            <td></td>
                                        </tr>
                                    </table>
                                </div>
                          </div>
                        </div>
                        <div class="panel panel-default">
                            <div class="panel-heading">Bray-Curtis Analysis</div>
                            <div class="panel-body">
                                <center>
                                    <div id='heatmap'></div>
                                </center>
                            </div>
                        </div>
                        <div class="panel panel-default">
                          <div class="panel-heading">Visualization</div>
                          <div class="panel-body">
                            Sample Name: <select id="bubbleplot_sample_name">
                                {% for sample_name in data.sample_names %}
                                    <option val="Clostridiales_{{sample_name}}">Clostridiales_{{sample_name}}</option>
                                {% endfor %}
                                {% for sample_name in data.sample_names %}
                                    <option val="Bacteroidales_{{sample_name}}">Bacteroidales_{{sample_name}}</option>
                                {% endfor %}
                            </select>
                            <li id="currentDisplay" class="selected" style="display: none;"><a></a></li>
                            <div id="viz_container">

                            </div>
                            <button onclick="$('#viz_legend').toggle();" class="btn btn-info" style="margin-bottom: 10px;">Show Info</button>
                            <div id="viz_legend" class="panel panel-default" style="display: none; text-align: justify;">
                                <div class="panel-body">
                                1. Colors represent voting tree percentage generated by random forest classification. That is, more the profile of the tested sample is similar to be classifier’s bacterial signature, higher the percentage will be. For a given source, if the index > 50%, the tested sample obtained the majority of the voting trees, is it considerated to be contaminated by the source. Inversely, if the index < 40%, the tested sample is not considerated to be contaminated by the source.
<br><br>
2. Each bubble represents an ASV that was selected in the classifiers. Blue are the ASVs that matched with the test sample. Red are the ASVs that were not found in the test sample. The bubble size is proportionate to the relative abundance of the ASV in the sample. Bubble that is associated to several source classifier has a darker inner circle. Each section of the outer circle represents a source. The larger the section, the more fecal contribution that source was among the sources investigated. Each arc along the circumference represents the relative abundance of the ASV within a source.
<br><br>
3. Bray−Curtis dissimilarity indices between the tested samples and the ones used to build the classifiers (relative abundance averaged per source). Indices were calculated by using bacterial ASV abundance. Low dissimilarity indices indicate a low dissimilarity (i.e. similarity) between samples.
                                </div>
                            </div>
                          </div>
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="row">
                    <div class="col-md-12">
                        <h4>Classifier failed for this FASTA file, it could not find any match.</h4>
                    </div>
                </div>
                {% endif %}
            {% else %}
            <div class="row">
                <div class="col-md-12">
                    <h4>Task Id not found</h4>
                </div>
            </div>
            {% endif %}
        </div>
<script type="text/javascript">

$(document).ready(function() {
    $(function () {
      $('[data-toggle="tooltip"]').tooltip()
    });
});

    //Once the document is ready we set javascript and page settings
    var screenWidth;
    var screenHeight;
    var task_id = '{{data.task_id}}';

    $(document).ready(function () {

        var rect;
        if (self==top) {
            rect = document.body.getBoundingClientRect();
        }
        else {
            rect =  parent.document.body.getBoundingClientRect();
        }

        //Set display size based on window size.
        screenWidth = (rect.width < 960) ? Math.round(rect.width*.95) : Math.round((rect.width - 210) *.95)
        screenHeight = Math.min(parent.innerHeight * 0.75, screenWidth);
        screenWidth = screenHeight;

        d3.select("#currentDisplay")
                .attr("item_value", screenWidth + "," + screenHeight)
                .attr("class", "selected")
                .html("<a>" + screenWidth + "px - " + screenHeight + "px</a>");

        // Set the size of our container element.
        viz_container = d3.selectAll("#viz_container")
                .style("width", screenWidth + "px")
                .style("height", screenHeight + "px");

        $('#bubbleplot_sample_name').change(function() {
             $('#viz_container').empty();
	     loadData(task_id, $('#bubbleplot_sample_name').val());
        });
        $('#bubbleplot_sample_name').trigger('change');


        drawHeatmap({{data.task_id}}, '#heatmap'); // heatmap.js

    });
</script>
</body>
</html>
